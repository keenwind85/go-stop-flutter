# 아바타 시스템 설계 문서

## 1. 개요

게임 진행 상황에 따라 동적으로 변화하는 아바타 시스템을 구현합니다.
아바타는 각 플레이어의 닉네임 영역 좌측에 표시되며, 게임 상태에 따라 자동으로 변경됩니다.

---

## 2. 에셋 구조

### 2.1 파일 위치
```
assets/avatar/
├── Host-normal.svg    # 호스트 기본 (게임 시작)
├── Host-4turn.svg     # 호스트 4턴 경과 후 기본
├── Host-win.svg       # 호스트 이기는 중
├── Host-lose.svg      # 호스트 지는 중
├── Host-mad.svg       # 호스트 광끼 모드
├── Guest-normal.svg   # 게스트 기본 (게임 시작)
├── Guest-4turn.svg    # 게스트 4턴 경과 후 기본
├── Guest-win.svg      # 게스트 이기는 중
├── Guest-lose.svg     # 게스트 지는 중
└── Guest-mad.svg      # 게스트 광끼 모드
```

### 2.2 pubspec.yaml 등록
```yaml
flutter:
  assets:
    - assets/avatar/
```

---

## 3. 아바타 상태 정의

### 3.1 AvatarState Enum
```dart
enum AvatarState {
  normal,    // 기본 (0~3턴)
  turn4,     // 4턴 이후 기본
  winning,   // 이기는 중 (1점 이상 앞서는 경우)
  losing,    // 지는 중 (1점 이상 뒤지는 경우)
  mad,       // 광끼 모드 (최우선)
}
```

### 3.2 상태 우선순위 (높은 순)
1. **mad (광끼 모드)** - 발동 시 게임 종료까지 유지, 다른 모든 상태 무시
2. **winning/losing** - 점수 차이에 따른 상태
3. **turn4** - 4턴 경과 후 기본 상태
4. **normal** - 초기 상태

---

## 4. 상태 결정 로직

### 4.1 턴 카운트 계산
```dart
// 덱 카드 수로 턴 계산 (초기 덱 24장, 매 턴 2장 사용)
int calculateTurnCount(int deckCount) {
  // 초기: 24장, 1턴 후: 22장, 2턴 후: 20장...
  return (24 - deckCount) ~/ 2;
}
```

### 4.2 아바타 상태 결정 알고리즘
```dart
AvatarState determineAvatarState({
  required bool isHost,
  required bool isGwangkkiMode,
  required int myScore,
  required int opponentScore,
  required int turnCount,
}) {
  // 1. 광끼 모드 최우선
  if (isGwangkkiMode) {
    return AvatarState.mad;
  }

  // 2. 점수 차이에 따른 상태 (점수가 발생한 경우에만)
  final scoreDiff = myScore - opponentScore;
  if (myScore > 0 || opponentScore > 0) {
    if (scoreDiff >= 1) {
      return AvatarState.winning;
    } else if (scoreDiff <= -1) {
      return AvatarState.losing;
    }
  }

  // 3. 4턴 이후 기본 상태
  if (turnCount >= 4) {
    return AvatarState.turn4;
  }

  // 4. 초기 상태
  return AvatarState.normal;
}
```

### 4.3 이미지 경로 결정
```dart
String getAvatarAssetPath(bool isHost, AvatarState state) {
  final prefix = isHost ? 'Host' : 'Guest';
  final suffix = switch (state) {
    AvatarState.normal => 'normal',
    AvatarState.turn4 => '4turn',
    AvatarState.winning => 'win',
    AvatarState.losing => 'lose',
    AvatarState.mad => 'mad',
  };
  return 'assets/avatar/$prefix-$suffix.svg';
}
```

---

## 5. UI 컴포넌트 설계

### 5.1 AvatarWidget 컴포넌트
```dart
class GameAvatar extends StatelessWidget {
  final bool isHost;
  final AvatarState state;
  final double size;
  final bool showBorderAnimation;

  const GameAvatar({
    super.key,
    required this.isHost,
    required this.state,
    this.size = 40,
    this.showBorderAnimation = true,
  });
}
```

### 5.2 테두리 애니메이션 효과

#### 5.2.1 상태별 테두리 색상
```dart
Color getBorderColor(AvatarState state) {
  return switch (state) {
    AvatarState.normal => Colors.grey,           // 회색 (차분)
    AvatarState.turn4 => Colors.blueGrey,        // 청회색 (진지)
    AvatarState.winning => Colors.amber,         // 금색 (기대)
    AvatarState.losing => Colors.blue,           // 파란색 (걱정)
    AvatarState.mad => Colors.deepOrange,        // 주황-빨강 (광기)
  };
}
```

#### 5.2.2 펄스 애니메이션 (승리/패배/광끼 상태)
```dart
// 점수 상태 변경 시 테두리 펄스 효과
// - winning: 금색 글로우 펄스
// - losing: 파란색 글로우 펄스
// - mad: 불꽃 테두리 애니메이션 (기존 광끼 효과와 동일)
```

#### 5.2.3 추천: 상태 전환 애니메이션
- 아바타 이미지 전환 시 **페이드 + 스케일** 효과
- 승리 → 패배 전환 시 잠깐 **흔들림** 효과
- 광끼 모드 진입 시 **확대 + 불꽃** 효과

---

## 6. 통합 위치

### 6.1 PlayerZone (하단 - 내 영역)
`lib/ui/game/widgets/player_zone.dart`의 `_buildInfoBar()` 메서드 수정:

```dart
Widget _buildInfoBar() {
  return Container(
    // ... 기존 스타일
    child: Row(
      children: [
        // [추가] 아바타 위젯
        GameAvatar(
          isHost: isHost,  // 새 파라미터 필요
          state: avatarState,  // 새 파라미터 필요
          size: 36,
        ),
        const SizedBox(width: 8),

        // 기존 턴 표시 + 닉네임
        // ...
      ],
    ),
  );
}
```

### 6.2 OpponentZone (상단 - 상대방 영역)
`lib/ui/game/widgets/opponent_zone.dart`의 `_buildNameSection()` 메서드 수정:

```dart
Widget _buildNameSection() {
  return Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    children: [
      Row(
        children: [
          // [추가] 아바타 위젯
          GameAvatar(
            isHost: !widget.isHost,  // 상대방이므로 반대
            state: opponentAvatarState,
            size: 32,
          ),
          const SizedBox(width: 6),

          // 기존 닉네임 + 턴 표시
          // ...
        ],
      ),
    ],
  );
}
```

### 6.3 game_screen_new.dart에서 상태 전달
```dart
// 아바타 상태 계산
final turnCount = (24 - (gameState?.deck.length ?? 24)) ~/ 2;

final hostScore = gameState?.scores.player1Score ?? 0;
final guestScore = gameState?.scores.player2Score ?? 0;

final hostAvatarState = determineAvatarState(
  isHost: true,
  isGwangkkiMode: _gwangkkiModeActive,
  myScore: hostScore,
  opponentScore: guestScore,
  turnCount: turnCount,
);

final guestAvatarState = determineAvatarState(
  isHost: false,
  isGwangkkiMode: _gwangkkiModeActive,
  myScore: guestScore,
  opponentScore: hostScore,
  turnCount: turnCount,
);
```

---

## 7. 추가 제안 사항

### 7.1 SVG 렌더링 최적화
- `flutter_svg` 패키지 사용
- 아바타 크기에 맞게 캐싱 적용

```dart
// pubspec.yaml
dependencies:
  flutter_svg: ^2.0.9
```

### 7.2 아바타 프리로딩
게임 시작 시 모든 아바타 이미지 프리로드하여 전환 시 끊김 방지:

```dart
Future<void> preloadAvatars(BuildContext context) async {
  final avatarPaths = [
    'assets/avatar/Host-normal.svg',
    'assets/avatar/Host-4turn.svg',
    // ... 모든 아바타
  ];

  for (final path in avatarPaths) {
    await precachePicture(
      ExactAssetPicture(SvgPicture.svgStringDecoderBuilder, path),
      context,
    );
  }
}
```

### 7.3 사운드 효과 연동
아바타 상태 변경 시 효과음 추가:
- 승리 상태 전환: 짧은 상승 효과음
- 패배 상태 전환: 짧은 하강 효과음
- 광끼 모드 진입: 불꽃 효과음 (기존 효과 활용)

### 7.4 접근성 고려
- 아바타 상태를 텍스트로도 표시 (Semantics 위젯 활용)
- 색맹 사용자를 위한 아이콘/패턴 추가 고려

### 7.5 향후 확장 가능성
- 사용자 커스텀 아바타 시스템
- 아바타 스킨 상점 (코인으로 구매)
- 시즌별/이벤트별 한정 아바타
- 승률/랭킹에 따른 특별 테두리 효과

---

## 8. 구현 순서 (권장)

1. **Phase 1: 기본 구조**
   - [ ] `AvatarState` enum 정의
   - [ ] `GameAvatar` 위젯 생성
   - [ ] SVG 렌더링 설정

2. **Phase 2: 상태 로직**
   - [ ] 턴 카운트 계산 로직
   - [ ] 아바타 상태 결정 로직
   - [ ] game_screen_new.dart에서 상태 전달

3. **Phase 3: UI 통합**
   - [ ] PlayerZone에 아바타 추가
   - [ ] OpponentZone에 아바타 추가
   - [ ] 레이아웃 조정

4. **Phase 4: 애니메이션**
   - [ ] 테두리 펄스 효과
   - [ ] 상태 전환 애니메이션
   - [ ] 광끼 모드 특수 효과

5. **Phase 5: 최적화**
   - [ ] 이미지 프리로딩
   - [ ] 성능 테스트
   - [ ] 사운드 연동 (선택)

---

## 9. 예상 소요 시간

- Phase 1: ~30분
- Phase 2: ~30분
- Phase 3: ~1시간
- Phase 4: ~1시간
- Phase 5: ~30분

**총 예상 시간: 약 3~4시간**

---

## 10. 참고 사항

### 현재 사용 중인 관련 기능
- `_gwangkkiModeActive`: 광끼 모드 상태 (game_screen_new.dart)
- `gameState.scores.player1Score / player2Score`: 점수 정보
- `gameState.deck.length`: 남은 덱 카드 수 (턴 계산용)

### 기존 애니메이션 참고
- 광끼 모드 불꽃 테두리: `_pulseController` 활용 (game_screen_new.dart:3026~3060)

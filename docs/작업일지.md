# Go-Stop (맞고) 게임 개발 작업일지

## 2025년 12월 5일 (목)

### 프로젝트 개요
- **프로젝트명**: go_stop_game
- **플랫폼**: Flutter + Flame 2D 게임 엔진
- **백엔드**: Firebase (Auth, Realtime Database)
- **상태관리**: Riverpod
- **게임 유형**: 2인 실시간 대전 맞고

---

### 완료된 작업

#### Phase 0: Firebase + Google Auth 설정
- [x] Flutter 프로젝트 생성 (`go_stop_game`)
- [x] 필수 패키지 추가 (pubspec.yaml)
  - flame: ^1.34.0
  - firebase_core: ^4.2.1
  - firebase_auth: ^6.1.2
  - firebase_database: ^12.1.0
  - google_sign_in: ^6.2.1 (6.x 버전 사용 - 7.x API 호환성 이슈)
  - flutter_riverpod: ^3.0.3
  - uuid: ^4.5.2
- [x] `AuthService` 클래스 구현
  - Google 로그인/로그아웃
  - `authStateProvider` (StreamProvider)
- [x] `firebase_options.dart` 템플릿 생성 (사용자 설정 필요)

#### Phase 1: GameRoom DB 데이터 구조 설계
- [x] `CardData` 모델 - 화투 카드 (월, 번호, 타입)
- [x] `PlayerInfo` 모델 - 플레이어 정보 (uid, displayName)
- [x] `CapturedCards` 모델 - 획득 카드 분류 (광, 열끗, 띠, 피)
- [x] `ScoreInfo` 모델 - 양측 점수
- [x] `GameState` 모델 - 게임 상태
  - turn (현재 턴 uid)
  - deck, floorCards
  - player1Hand, player2Hand
  - player1Captured, player2Captured
  - scores
- [x] `GameRoom` 모델
  - roomId (4자리 대문자)
  - host, guest (PlayerInfo)
  - state (waiting/playing/finished)
  - gameState

#### Phase 2: 매칭 및 방 입장 로직
- [x] `RoomService` 구현
  - `createRoom()` - 방 생성 (4자리 코드)
  - `getWaitingRooms()` - 대기 중인 방 목록
  - `joinRoom()` - Transaction으로 동시 입장 방지
  - `watchRoom()` - 실시간 방 상태 감시 (Stream)
  - `leaveRoom()` - 방 나가기
  - `updateGameStateWithTransaction()` - 게임 상태 업데이트

#### Phase 3: MatgoLogicService 게임 로직
- [x] `DeckGenerator` - 48장 덱 생성 및 배분
- [x] `ScoreCalculator` - 점수 계산 로직
  - 광 점수 (3광, 4광, 5광, 비광, 쌍피광)
  - 열끗 점수 (10개 이상)
  - 띠 점수 (5개 이상, 홍단, 청단, 초단)
  - 피 점수 (10개 이상)
- [x] `MatgoLogicService` 구현
  - `initializeGame()` - 게임 초기화
  - `playCard()` - 카드 플레이 로직
    - 같은 월 카드 매칭
    - 덱에서 카드 뒤집기
    - 카드 획득/바닥 배치
    - 턴 전환

#### Phase 4: Flame 실시간 화면 갱신
- [x] `CardComponent` - Flame 카드 스프라이트
  - 터치 인터랙션
  - 선택/하이라이트 상태
  - 카드 앞면/뒷면
- [x] `MatgoGame` - Flame 게임 엔진
  - `onGameStateChanged()` - Firebase 상태 변경 시 UI 갱신
  - 내 손패/상대 손패/바닥/덱 배치
  - 내 턴일 때만 카드 터치 활성화
  - 카드 선택 및 매칭 로직

#### UI 화면
- [x] `LoginScreen` - Google 로그인 버튼
- [x] `LobbyScreen` - 방 목록, 방 생성, 코드로 입장
- [x] `GameScreen` - Flame 게임 뷰 + HUD

#### 기타
- [x] `main.dart` - Firebase 초기화, Riverpod 설정, 라우팅
- [x] 카드 이미지 복사 (기존 프로젝트에서 48장 + 뒷면)
- [x] 코드 분석 통과 (에러 0개)

---

### 프로젝트 파일 구조
```
go_stop_game/
├── lib/
│   ├── main.dart
│   ├── firebase_options.dart           # ✅ FlutterFire CLI로 자동 생성
│   ├── config/
│   │   └── constants.dart
│   ├── models/
│   │   ├── card_data.dart
│   │   ├── player_info.dart
│   │   ├── captured_cards.dart
│   │   └── game_room.dart
│   ├── services/
│   │   ├── auth_service.dart
│   │   ├── room_service.dart
│   │   └── matgo_logic_service.dart
│   ├── game/
│   │   ├── matgo_game.dart
│   │   ├── components/
│   │   │   └── card_component.dart
│   │   └── systems/
│   │       ├── deck_generator.dart
│   │       └── score_calculator.dart
│   └── ui/screens/
│       ├── login_screen.dart
│       ├── lobby_screen.dart
│       └── game_screen.dart
├── assets/images/cards/               # 화투 카드 이미지 48장 + 뒷면
├── pubspec.yaml
└── 작업일지.md
```

---

---

## 2025년 12월 8일 (일)

### 완료된 작업

#### game_rule.md 기반 핵심 로직 보완

##### Phase 1: 핵심 로직 보완 ✅
- [x] **보너스 피 2장 추가** - 덱 50장 구성 (48장 + 보너스 피 2장)
- [x] **CardType 확장** - `doublePi`, `bonusPi` 타입 추가
- [x] **CardData 확장** - `piCount` getter, `isBonus` 속성 추가
- [x] **총통 규칙** - 손패에 같은 월 4장 있으면 즉시 승리
- [x] **DeckGenerator 개선**
  - 손패 10장씩, 바닥 8장, 덱 나머지
  - 바닥 보너스 카드는 선공에게 즉시 지급
  - 총통 체크 로직
- [x] **GameState 확장**
  - `SpecialEvent` enum (puk, jaPuk, ttadak, kiss, sweep, sulsa, shake, bomb, chongtong)
  - `GameEndState` enum (none, win, nagari, chongtong)
  - 특수 이벤트 필드 (lastEvent, lastEventPlayer)
  - 뻑 추적 필드 (pukCards, pukOwner)
  - 게임 종료 필드 (endState, winner, finalScore)
  - Go/Stop 대기 필드 (waitingForGoStop, goStopPlayer)
- [x] **ScoreInfo 확장** - multiplier, shaking 필드 추가
- [x] **CapturedCards 확장**
  - `piCount` getter (쌍피 2장 계산)
  - `addCards()` 메서드
  - `removePi()` 메서드 (피 뺏기용)
- [x] **MatgoLogicService 완전 재작성**
  - 모든 특수 이벤트 구현: 뻑, 자뻑, 따닥, 쪽, 싹쓸이, 설사
  - 피 뺏기 로직
  - Go/Stop 판정 (7점 기준)
  - 흔들기/폭탄 선언

##### Phase 2: 점수 시스템 완성 ✅
- [x] **ScoreCalculator 완전 재작성**
  - 고도리 5점 (2, 4, 8월 열끗 3장)
  - 홍단 3점 (1, 2, 3월 띠 3장)
  - 청단 3점 (6, 9, 10월 띠 3장)
  - 초단 3점 (4, 5, 7월 띠 3장)
  - 광 점수 (삼광 3점, 비광삼광 2점, 사광 4점, 오광 15점)
  - 열끗 점수 (5장부터 1점씩)
  - 띠 점수 (5장부터 1점씩)
  - 피 점수 (10장부터 1점씩, 쌍피 2장 계산)
- [x] **FinalScoreResult** - 배수 적용 최종 점수
  - 고 배수 (1고=2배, 2고=4배, 3고+=1배 추가)
  - 피박/광박/멍따리기 2배
  - 흔들기/폭탄 배수

---

### 다음 작업 예정 (TODO)

#### ~~필수 - Firebase 설정~~ ✅ 완료 (2025-12-08)
- FlutterFire CLI로 `go-stop-flutter` 프로젝트 연동 완료
- `lib/firebase_options.dart` 자동 생성됨
- Web App ID: `1:37532106702:web:da8314e32012a0846a359f`
- Database URL: `https://go-stop-flutter-default-rtdb.asia-southeast1.firebasedatabase.app`

#### ~~Phase 3: UI/UX 및 결과 화면~~ ✅ 완료 (2025-12-08)
- [x] 게임 종료 결과 화면 (점수 상세 내역) - `game_result_dialog.dart`
- [x] Go/Stop 선택 UI - `go_stop_dialog.dart`
- [x] 특수 이벤트 알림 표시 - `special_event_overlay.dart`
- [x] game_screen.dart 완전 재작성 - 모든 UI 위젯 통합

##### 신규 생성 파일
- `lib/ui/widgets/go_stop_dialog.dart` - Go/Stop 선택 다이얼로그
- `lib/ui/widgets/game_result_dialog.dart` - 게임 결과 화면 (점수 상세 포함)
- `lib/ui/widgets/special_event_overlay.dart` - 특수 이벤트 애니메이션 오버레이

##### game_screen.dart 주요 변경
- 특수 이벤트 오버레이 표시 (뻑, 따닥, 쪽 등)
- Go/Stop 다이얼로그 표시 (7점 이상 도달 시)
- 게임 종료 결과 다이얼로그 표시
- HUD에 점수 및 턴 표시

#### 기능 개선 ✅ 완료 (2025-12-08)
- [x] 흔들기/폭탄 선언 UI 버튼 - `action_buttons.dart`
- [x] 재대결 기능 연동 - `room_service.dart` 확장
- [x] 사운드 효과 추가 - `sound_service.dart`
- [x] 카드 애니메이션 개선 - `card_component.dart` 확장

##### 상세 변경 내용

###### action_buttons.dart (신규)
- 흔들기 버튼: 같은 월 카드 3장 이상 보유 시 활성화
- 폭탄 버튼: 같은 월 카드 3장 보유 + 바닥에 1장 있을 시 활성화
- 그라데이션 스타일 버튼 디자인

###### sound_service.dart (신규)
- audioplayers 패키지 활용
- 카드 효과음 (flip, place, match)
- 특수 이벤트 효과음 (뻑, 싹쓸이, 쪽 등)
- Go/Stop, 승리/패배 효과음
- 음소거 및 볼륨 조절 기능

###### room_service.dart 확장
- `requestRematch()` - 재대결 요청
- `startRematch()` - 재대결 시작 (양측 동의 시)

###### game_room.dart 확장
- `hostRematchRequest`, `guestRematchRequest` 필드 추가
- `bothWantRematch` getter 추가

###### card_component.dart 대폭 확장
- `dealAnimation()` - 카드 딜링 애니메이션 (회전 + 스케일)
- `captureAnimation()` - 카드 캡처 애니메이션 (튀어오름 + 회전)
- `pukAnimation()` - 뻑 애니메이션 (좌우 흔들림)
- `sweepAnimation()` - 싹쓸이 애니메이션 (글로우 + 회전)
- `kissAnimation()` - 쪽 애니메이션 (점프)
- `shakeOrBombAnimation()` - 흔들기/폭탄 애니메이션
- `ttadakAnimation()` - 따닥 애니메이션 (2회 점프)
- `sulsaAnimation()` - 설사 애니메이션 (회전 확대)
- `goAnimation()` - Go 선언 애니메이션
- `victoryAnimation()` - 승리 애니메이션 (무한 반복)
- `fadeInAnimation()`, `fadeOutAnimation()` - 등장/퇴장 애니메이션
- `startPulseAnimation()` - 펄스 강조 애니메이션
- `_showGlow()` - 글로우 효과 (색상별)
- `stopAllEffects()` - 모든 이펙트 중지

###### game_screen.dart 통합
- SoundService 연동
- ActionButtons 위젯 배치
- 재대결 요청/대기 상태 표시
- 사운드 토글 버튼 추가
- 배수(multiplier) 표시 추가

###### pubspec.yaml 업데이트
- `audioplayers: ^6.1.0` 추가
- `assets/sounds/` 폴더 추가

#### 보안 강화
- [ ] Firebase Realtime Database 보안 규칙 설정
- [ ] 치팅 방지 서버 검증 로직

#### 배포 준비
- [ ] 웹 배포 설정

---

### 기술적 메모

#### google_sign_in 버전 이슈
- 7.x 버전은 API가 크게 변경되어 호환성 문제 발생
- 6.2.1 버전 사용으로 해결
- `GoogleSignIn()` 생성자와 `signIn()` 메서드 정상 작동

#### Firebase Transaction 사용
- `joinRoom()`에서 동시 입장 방지를 위해 Transaction 사용
- `playCard()`에서 게임 상태 일관성을 위해 Transaction 사용

#### Flame 엔진 구조
- `MatgoGame` extends `FlameGame`
- `CardComponent` extends `SpriteComponent`
- `onGameStateChanged()`로 Firebase 상태 변경 시 UI 전체 갱신

---

### 참고 명령어
```bash
# 프로젝트 디렉토리
cd /Users/wook/Desktop/test/claude-go/go_stop_game

# 의존성 설치
flutter pub get

# 코드 분석
flutter analyze

# 웹 실행
flutter run -d chrome

# 빌드
flutter build web
```

# 고스톱(3인) vs 맞고(2인) 모드 차이점 분석

> **분석 목적**: 현재 코드베이스에서 맞고 모드에서는 지원하지만 고스톱 모드에서 미지원이거나 다른 로직이 필요한 부분을 리스트업
>
> **참고**: 일부 항목은 의도적으로 고스톱 모드에서 지원하지 않는 것이 맞는 경우도 있음

---

## 1. 기본 규칙 차이 (constants.dart)

| 항목 | 맞고 (2인) | 고스톱 (3인) | 비고 |
|------|-----------|-------------|------|
| 플레이어 수 | 2명 | 3명 | `GameMode.playerCount` |
| 손패 장수 | 10장 | 7장 | `GameMode.cardsPerPlayer` |
| 바닥패 장수 | 8장 | 6장 | `GameMode.fieldCardCount` |
| 승리 점수 | 7점 | 3점 | `GameMode.winThreshold` |
| 피박 기준 | 7장 이하 | 5장 이하 | `GameMode.piBakThreshold` |

---

## 2. matgo_logic_service.dart 미지원/차이점

### 2.1 `selectDeckMatchCard` 함수 (라인 1682-1870)
**상태**: ❌ 고스톱 3인 미지원
**위치**: `lib/services/matgo_logic_service.dart:1682`

```dart
// 문제: isPlayer1 패턴 사용 - player3 고려 안함
final isPlayer1 = playerNumber == 1;
var myCaptured = isPlayer1 ? current.player1Captured : current.player2Captured;
var opponentCaptured = isPlayer1 ? current.player2Captured : current.player1Captured;
```

**필요 수정**:
- `isPlayer1 ? X : Y` 패턴을 `switch (playerNumber)` 패턴으로 변경
- player3Hand, player3Captured 처리 추가
- 피 뺏기 로직에 2명의 상대방 처리 추가
- 9월 열끗 선택 시 player3 상태 유지

---

### 2.2 덱 소진 시 게임 종료 로직
**상태**: ❌ 고스톱 3인 미완성
**위치**: 여러 함수에 분산

#### `flipDeckOnly` (라인 1441)
```dart
// TODO: 3인 고스톱 모드 덱 소진 시 게임 종료 로직 추가 필요
```

#### `selectDeckMatchCard` (라인 1810-1842)
```dart
// 문제: 2인 전용 손패 비움 체크
final myHandEmpty = isPlayer1
    ? current.player1Hand.isEmpty
    : current.player2Hand.isEmpty;
final opponentHandEmpty = isPlayer1
    ? current.player2Hand.isEmpty
    : current.player1Hand.isEmpty;
```

**필요 수정**:
- 3인 모두의 손패 비움 체크 필요
- `checkGameEndOnExhaustion` 함수가 2인 전용 파라미터 사용 중

---

### 2.3 `checkGameEndOnExhaustion` 함수 (라인 116-200)
**상태**: ⚠️ 부분 지원 (2인 로직)
**위치**: `lib/services/matgo_logic_service.dart:116`

**현재 파라미터**:
```dart
GameEndCheckResult checkGameEndOnExhaustion({
  required int myScore,
  required int opponentScore,  // 단일 상대
  required int myGoCount,
  required int opponentGoCount,  // 단일 상대
  ...
})
```

**필요 수정**:
- 3인 게임에서는 2명의 상대방 점수/고카운트 비교 필요
- 고박 판정 로직이 2명의 상대에게 적용되어야 함

---

### 2.4 `chooseSeptemberAnimalType` 함수 (라인 2350-2500)
**상태**: ❌ 고스톱 3인 미지원
**위치**: `lib/services/matgo_logic_service.dart:2355`

```dart
// 문제: isPlayer1 패턴 사용
var myCaptured = isPlayer1 ? current.player1Captured : current.player2Captured;
...
final opponentCaptured = isPlayer1 ? current.player2Captured : current.player1Captured;
```

**필요 수정**: switch 패턴으로 3인 지원 필요

---

### 2.5 `flipDeckOnly` 내부 점수 계산 (라인 1412-1420)
**상태**: ⚠️ 부분 지원
**위치**: `lib/services/matgo_logic_service.dart:1412`

```dart
// 2인 맞고 모드에서만 덱 소진 시 게임 종료 체크
if (!isGostopMode && deck.isEmpty && !waitingForGoStop) {
  final isPlayer1 = playerNumber == 1;
  final opponentScore = ScoreCalculator.calculateScore(opponent1Captured);

  final myGoCount = isPlayer1 ? scores.player1GoCount : scores.player2GoCount;
  // ... 2인 전용 로직
}
```

**비고**: 의도적으로 2인 모드에서만 처리하도록 되어 있으나, 3인 모드 로직은 TODO로 남아있음

---

## 3. 아이템 시스템

### 3.1 player3 아이템 효과 미지원
**상태**: ⚠️ 의도적 미지원 (주석 명시)
**위치**: `lib/services/matgo_logic_service.dart:727`

```dart
// 현재 player3ItemEffects는 지원하지 않음 (3인 게임에서 아이템 미지원)
final myItemEffects = playerNumber == 1
    ? current.player1ItemEffects
    : (playerNumber == 2 ? current.player2ItemEffects : null);
```

**비고**: 3인 게임에서는 아이템 시스템을 지원하지 않기로 한 것으로 보임 (의도적)

---

## 4. UI 관련 차이점

### 4.1 `game_screen_new.dart` - 상대방 UID 결정
**상태**: ⚠️ 부분 지원 필요
**위치**: `lib/ui/game/game_screen_new.dart:2537`

```dart
final opponentUid = widget.isHost ? room.guest?.uid : room.host.uid;
```

**비고**: 일부 함수에서 단일 opponentUid만 사용 - 3인 모드에서는 2명의 상대가 있음

### 4.2 `_selectDeckMatchCard` 호출 (라인 1603-1613)
**상태**: ⚠️ opponentUid 결정 로직 검토 필요
**위치**: `lib/ui/game/game_screen_new.dart:1603`

```dart
final opponentUid = widget.isHost
    ? _currentRoom!.guest?.uid ?? ''
    : _currentRoom!.host.uid;
```

---

## 5. game_screen.dart (레거시)
**상태**: ❌ 전체적으로 2인 전용
**위치**: `lib/ui/screens/game_screen.dart`

레거시 게임 화면으로, 전반적으로 `widget.isHost ? 1 : 2` 패턴 사용:
- 라인 74, 260, 302, 318, 371, 391, 580 등

**비고**: game_screen_new.dart가 메인 UI로 사용되므로 레거시 파일은 우선순위 낮음

---

## 6. 코인 정산 시스템

### 6.1 settleGame (2인) vs settleGostopGame (3인)
**상태**: ✅ 별도 함수로 분리됨
**위치**: `lib/services/coin_service.dart`

- `settleGame()` (라인 732): 맞고 2인 정산
- `settleGostopGame()` (라인 805): 고스톱 3인 정산

**비고**: 올바르게 분리되어 있음

---

## 7. 모델 관련

### 7.1 GameState
**상태**: ✅ player3 필드 존재
**위치**: `lib/models/game_room.dart`

- player3Hand, player3Captured
- player3ItemEffects
- turnOrder, currentTurnIndex (3인 턴 관리)

### 7.2 ScoreInfo
**상태**: ✅ player3 필드 존재
**위치**: `lib/models/game_room.dart`

- player3Score, player3GoCount, player3Multiplier
- player3Shaking, player3Bomb

---

## 8. 수정 우선순위 제안

### 높음 (게임 진행에 영향)
1. `selectDeckMatchCard` - 3인 지원 추가
2. 덱 소진 시 게임 종료 로직 (3인용)
3. `chooseSeptemberAnimalType` - 3인 지원 추가

### 중간 (완성도)
4. `checkGameEndOnExhaustion` - 3인용 오버로드 또는 수정
5. UI에서 opponentUid 결정 로직 검토

### 낮음 (의도적 미지원 또는 레거시)
6. player3 아이템 효과 (현재 의도적 미지원)
7. game_screen.dart 레거시 파일

---

## 9. 공통 패턴 변환 가이드

### 변환 전 (2인 전용)
```dart
final isPlayer1 = playerNumber == 1;
var myCaptured = isPlayer1 ? current.player1Captured : current.player2Captured;
var opponentCaptured = isPlayer1 ? current.player2Captured : current.player1Captured;
```

### 변환 후 (3인 지원)
```dart
// 내 획득패
var myCaptured = switch (playerNumber) {
  1 => current.player1Captured,
  2 => current.player2Captured,
  3 => current.player3Captured,
  _ => current.player1Captured,
};

// 상대방 획득패 (3인: 2명 모두)
final isGostopMode = current.gameMode == GameMode.gostop;
var opponent1Captured = playerNumber == 1
    ? current.player2Captured
    : current.player1Captured;
var opponent2Captured = isGostopMode
    ? (playerNumber == 3
        ? current.player2Captured
        : current.player3Captured)
    : const CapturedCards();  // 2인 모드에서는 사용 안함
```

---

*문서 작성일: 2025-12-17*
*분석 대상: go_stop_game 프로젝트*

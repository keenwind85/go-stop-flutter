# 아이템 시스템 설계 문서

## 1. 개요

Go-Stop 게임에 아이템 시스템을 도입하여 게임의 전략적 깊이와 재미를 증가시킵니다.

### 1.1 핵심 기능
- **아이템 상점**: 매일 00:00 리셋, 8개 중 3개 랜덤 판매
- **아이템 사용**: 게임 중 1회 사용 가능, 화려한 애니메이션 연출
- **아이템 보유**: 각 아이템 1개씩만 보유 가능

---

## 2. 아이템 목록

| 아이템명 | 가격 | 요약 설명 | 효과 | 사용 조건 |
|---------|------|----------|------|----------|
| 光끼의 물약 | 100 | 아이템 사용자의 光끼 게이지가 즉시 차오릅니다 | 光끼 게이지를 100으로 설정 | 光끼 모드 미발동, 상대 게이지 100 미만 |
| 제발 Go만해! | 50 | 아이템 공격을 당한 플레이어는 Go만 가능합니다 | 상대방 Go/Stop에서 Go만 선택 가능 | 없음 |
| 제발 Stop만해! | 50 | 아이템 공격을 당한 플레이어는 Stop만 가능합니다 | 상대방 Go/Stop에서 Stop만 선택 가능 | 없음 |
| 우리 패 바꾸자! | 50 | 플레이어의 손패를 서로 교환합니다 | 양 플레이어 손패 전체 교환 | 없음 |
| 밑장 빼기 | 30 | 아이템 사용자가 더미패 1장을 몰래 가져갑니다 | 더미패에서 랜덤 1장 → 내 손패 | 더미패 1장 이상 |
| 손패 교체 | 30 | 아이템 사용자가 더미패에서 랜덤으로 카드를 교체합니다 | 손패 전체를 더미패 랜덤 카드로 교체 | 더미패 ≥ 손패 개수 |
| 바닥패 교체 | 30 | 아이템 사용으로 바닥패가 교체됩니다 | 바닥패 전체를 더미패 랜덤 카드로 교체 | 더미패 ≥ 바닥패 개수 |
| 光의 기운 | 30 | 아이템 사용자가 광을 뽑을 확률이 증가합니다 | 3턴간 더미패 뒤집기 시 광 최우선 출현 | 더미패에 광 카드 존재 |

---

## 3. 시스템 아키텍처

### 3.1 데이터 모델

#### Firebase 데이터 구조
```
users/
  {uid}/
    items/
      inventory/           # 보유 아이템
        gwangkki_potion: 1
        force_go: 0
        ...
      daily_purchases/     # 오늘 구매한 아이템
        date: "2025-01-01"
        items: ["gwangkki_potion"]
    wallet/
      coin: 500
      ...

global/
  item_shop/
    today_items: ["gwangkki_potion", "force_go", "swap_hands"]
    last_reset: "2025-01-01T00:00:00Z"

rooms/
  {roomId}/
    gameState/
      ...
      itemEffects/
        player1/
          used_item: null | "force_go"
          force_go_only: false
          force_stop_only: false
          gwang_priority_turns: 0
        player2/
          ...
```

### 3.2 새로운 파일 구조

```
lib/
├── models/
│   └── item_data.dart              # 아이템 데이터 모델
├── services/
│   └── item_service.dart           # 아이템 서비스 (구매, 사용, 상점 관리)
├── ui/
│   ├── widgets/
│   │   ├── item_shop_dialog.dart   # 상점 다이얼로그
│   │   ├── item_use_button.dart    # 아이템 사용 버튼 (게임 내)
│   │   └── item_use_overlay.dart   # 아이템 사용 애니메이션 오버레이
│   └── game/
│       └── game_screen_new.dart    # 기존 파일 수정 (아이템 사용 UI 추가)
```

---

## 4. 구현 계획

### Phase 1: 데이터 모델 및 서비스 (예상: 2-3시간)

#### 4.1.1 `item_data.dart` 생성
```dart
enum ItemType {
  gwangkkiPotion,     // 光끼의 물약
  forceGo,            // 제발 Go만해!
  forceStop,          // 제발 Stop만해!
  swapHands,          // 우리 패 바꾸자!
  stealFromDeck,      // 밑장 빼기
  replaceHand,        // 손패 교체
  replaceFloor,       // 바닥패 교체
  gwangPriority,      // 光의 기운
}

class ItemData {
  final ItemType type;
  final String name;
  final String description;
  final int price;
  final String iconPath;

  // 사용 조건 검사 메서드
  bool canUse(GameState state, String playerUid);

  // 효과 적용 메서드
  GameState applyEffect(GameState state, String playerUid, String opponentUid);
}
```

#### 4.1.2 `item_service.dart` 생성
```dart
class ItemService {
  // 상점 관련
  Future<List<ItemType>> getTodayShopItems();
  Future<void> resetShopIfNeeded();

  // 구매 관련
  Future<bool> canPurchaseItem(String uid, ItemType item);
  Future<({bool success, String message})> purchaseItem(String uid, ItemType item);

  // 보유 관련
  Future<Map<ItemType, int>> getUserInventory(String uid);
  Stream<Map<ItemType, int>> getUserInventoryStream(String uid);

  // 사용 관련
  Future<({bool success, String message})> useItem(
    String roomId,
    String playerUid,
    String opponentUid,
    ItemType item,
    int playerNumber,
  );
}
```

### Phase 2: 상점 UI (예상: 2-3시간)

#### 4.2.1 로비 화면 수정 (`lobby_screen.dart`)
- "새 게임 만들기" 버튼 위에 "아이템 상점" 버튼 추가
- 버튼 클릭 시 `ItemShopDialog` 표시

#### 4.2.2 `item_shop_dialog.dart` 생성
- 오늘의 아이템 3개 표시
- 각 아이템: 아이콘, 이름, 설명, 가격, 구매 버튼
- 구매 불가 조건:
  - 코인 부족
  - 이미 보유 중
  - 오늘 해당 아이템 구매 완료
- 시각적 피드백: 구매 가능/불가능 상태 명확히 표시

### Phase 3: 게임 내 아이템 사용 (예상: 3-4시간)

#### 4.3.1 게임 화면 수정 (`game_screen_new.dart`)
- 하단 점수 영역 좌측에 아이템 사용 버튼 추가
- 버튼 상태:
  - 활성화: 보유 아이템 있음 + 미사용
  - 비활성화: 아이템 없음 또는 이미 사용
- 클릭 시 보유 아이템 목록 표시

#### 4.3.2 `item_use_button.dart` 생성
- 아이템 보유 개수 표시 배지
- 클릭 시 사용 가능 아이템 목록 팝업

#### 4.3.3 `item_use_overlay.dart` 생성
- 화면 중앙 애니메이션 연출
- "[플레이어]가 [아이템]을 사용하였습니다"
- 하단 서브타이틀: 아이템 요약 설명
- 로티 또는 커스텀 애니메이션

### Phase 4: 아이템 효과 로직 (예상: 4-5시간)

#### 4.4.1 GameState 확장 (`game_room.dart`)
```dart
class ItemEffects {
  final String? usedItem;           // 사용한 아이템
  final bool forceGoOnly;           // Go만 가능
  final bool forceStopOnly;         // Stop만 가능
  final int gwangPriorityTurns;     // 광 우선 남은 턴 수

  // JSON 변환 메서드
}

class GameState {
  // 기존 필드...
  final ItemEffects? player1ItemEffects;
  final ItemEffects? player2ItemEffects;
  final bool player1ItemUsed;  // 게임 중 아이템 사용 여부
  final bool player2ItemUsed;
}
```

#### 4.4.2 MatgoLogicService 수정 (`matgo_logic_service.dart`)
- 각 아이템 효과 처리 로직 추가
- 光의 기운: 덱 뒤집기 시 광 카드 우선 처리
- Go/Stop 제한: Go/Stop 다이얼로그 로직 수정

### Phase 5: 애니메이션 및 폴리싱 (예상: 2-3시간)

#### 4.5.1 아이템 사용 애니메이션
- 로티 애니메이션 파일 추가 (`assets/items/`)
- 아이템별 고유 효과음

#### 4.5.2 상점 UI 폴리싱
- 아이템 카드 디자인
- 구매 성공/실패 애니메이션

---

## 5. 상세 구현 사양

### 5.1 상점 리셋 로직

```dart
/// 매일 00:00 UTC+9(한국 시간) 기준 리셋
Future<void> resetShopIfNeeded() async {
  final shopRef = _db.child('global/item_shop');
  final snapshot = await shopRef.get();

  final now = DateTime.now();
  final today = DateTime(now.year, now.month, now.day);

  if (needsReset(snapshot, today)) {
    // 8개 중 3개 랜덤 선택
    final allItems = ItemType.values.toList()..shuffle();
    final todayItems = allItems.take(3).map((e) => e.name).toList();

    await shopRef.set({
      'today_items': todayItems,
      'last_reset': today.toIso8601String(),
    });
  }
}
```

### 5.2 아이템 효과 구현

#### 光끼의 물약
```dart
GameState applyGwangkkiPotion(GameState state, String playerUid) {
  final isPlayer1 = state.turn == playerUid; // 사용자 판별 필요

  // 光끼 게이지를 100으로 설정하는 로직은 CoinService의
  // gwangkkiScore를 직접 수정해야 함
  // GameState에서는 발동 가능 상태만 체크

  return state; // 실제 효과는 CoinService에서 처리
}
```

#### 光의 기운
```dart
CardData? getNextDeckCard(List<CardData> deck, int gwangPriorityTurns) {
  if (gwangPriorityTurns > 0) {
    // 덱에서 광 카드 찾기
    final gwangCard = deck.firstWhere(
      (card) => card.type == CardType.gwang,
      orElse: () => deck.first, // 없으면 일반 카드
    );
    return gwangCard;
  }
  return deck.first;
}
```

---

## 6. UI/UX 설계

### 6.1 아이템 상점 다이얼로그

```
┌─────────────────────────────────────┐
│         ⭐ 오늘의 아이템 ⭐          │
├─────────────────────────────────────┤
│  ┌───────┐                          │
│  │ 아이콘 │  光끼의 물약              │
│  └───────┘  "光끼 게이지가 즉시..."   │
│             💰 100코인  [구매]       │
├─────────────────────────────────────┤
│  ┌───────┐                          │
│  │ 아이콘 │  제발 Go만해!            │
│  └───────┘  "공격당한 플레이어는..."  │
│             💰 50코인   [보유중]     │
├─────────────────────────────────────┤
│  ┌───────┐                          │
│  │ 아이콘 │  밑장 빼기               │
│  └───────┘  "더미패 1장을 몰래..."    │
│             💰 30코인   [구매완료]   │
├─────────────────────────────────────┤
│                                     │
│  내 코인: 💰 350                     │
│                [닫기]                │
└─────────────────────────────────────┘
```

### 6.2 게임 내 아이템 버튼

```
┌─────────────────────────────────────┐
│  상대방 영역                         │
├─────────────────────────────────────┤
│  바닥 영역                           │
├─────────────────────────────────────┤
│ [🎁 2]  내 점수: 15점  💰 350        │
│  ↑                                  │
│  아이템 버튼 (보유 2개)              │
└─────────────────────────────────────┘
```

### 6.3 아이템 사용 애니메이션

```
┌─────────────────────────────────────┐
│                                     │
│                                     │
│     ✨ [플레이어명]님이 ✨          │
│                                     │
│    ⚡ [光끼의 물약] ⚡              │
│                                     │
│     을(를) 사용하였습니다!          │
│                                     │
│  "光끼 게이지가 즉시 차오릅니다"    │
│                                     │
└─────────────────────────────────────┘
```

---

## 7. 추가 아이디어 제안


## 8. 구현 우선순위

(필수)
1. ✅ 아이템 데이터 모델 (`item_data.dart`)
2. ✅ 아이템 서비스 (`item_service.dart`)
3. ✅ 상점 UI (`item_shop_dialog.dart`)
4. ✅ 게임 내 사용 버튼 (`item_use_button.dart`)
5. ✅ 8개 기본 아이템 효과 구현


---

## 10. 테스트 체크리스트

### 상점 테스트
- [ ] 매일 00:00에 상점 아이템 리셋
- [ ] 3개 아이템 랜덤 표시
- [ ] 코인 부족 시 구매 불가
- [ ] 이미 보유 중인 아이템 구매 불가
- [ ] 오늘 구매한 아이템 재구매 불가
- [ ] 구매 후 코인 차감 및 인벤토리 추가

### 게임 내 사용 테스트
- [ ] 아이템 보유 시 버튼 활성화
- [ ] 게임당 1회만 사용 가능
- [ ] 사용 후 버튼 비활성화
- [ ] 사용 애니메이션 정상 표시
- [ ] 양쪽 플레이어에게 알림 표시

### 각 아이템 효과 테스트
- [ ] 光끼의 물약: 게이지 100 설정, 조건 검사
- [ ] 제발 Go만해!: 상대방 Go만 선택 가능
- [ ] 제발 Stop만해!: 상대방 Stop만 선택 가능
- [ ] 우리 패 바꾸자!: 손패 교환 정상 처리
- [ ] 밑장 빼기: 더미패 → 손패 추가
- [ ] 손패 교체: 손패 전체 교체
- [ ] 바닥패 교체: 바닥패 전체 교체
- [ ] 光의 기운: 3턴간 광 우선 출현

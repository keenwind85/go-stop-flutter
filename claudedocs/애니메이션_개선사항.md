# 맞고 게임 애니메이션 개선 작업

## 작업 배경

오프라인 맞고의 물리적 카드 움직임과 현재 구현된 애니메이션 사이에 괴리가 있어 게임 플레이 시 어색함이 발생함.

---

## 오프라인 맞고의 실제 물리 흐름

### 플레이어 턴 진행 순서

1. **손패 카드 내기**
   - 매칭 O: 바닥의 짝 카드 위에 "던져서 쌓음"
   - 매칭 X: 바닥의 빈 공간으로 "던짐"

2. **덱 카드 뒤집기**
   - 가운데 더미에서 카드를 뒤집어 어떤 카드인지 확인
   - 공중에서 잠시 보여준 후 목적지로 "던짐"

3. **덱 카드 목적지 결정**
   - 매칭 O: 해당 바닥 카드 위에 "던져서 쌓음"
   - 매칭 X: 빈 공간으로 "던짐"

4. **카드 획득 (해당 시)**
   - 획득 가능한 카드들이 잠시 보인 후 → 획득 (점수패)영역으로 "쓸어담음"

---

## 현재 구현의 문제점

### 문제 1: 덱 카드 "던지기" 시각화 부족

**현재 동작:**
```
덱 → 위로 올라옴 → 뒤집기 → 바로 목적지 착지
```

**문제점:**
- 덱 카드가 "날아가서 쌓이는" 중간 과정이 생략됨
- 어떤 카드와 매칭되어 쌓이는지 시각적으로 인지하기 어려움

**관련 코드:** `lib/ui/game/animations/card_animator.dart` - `playDeckFlipToFloor()`

---

### 문제 2: 덱 플립 후 대기 시간 부족

**현재 설정:**
```dart
Duration pauseDuration = const Duration(milliseconds: 300)
```

**문제점:**
- 300ms는 뒤집힌 카드를 인식하기에 너무 짧음
- 특히 뻑/따닥/쪽 등 특수 상황에서 무슨 일이 일어났는지 파악하기 어려움

**관련 코드:** `lib/ui/game/animations/card_animator.dart:193`

---

### 문제 3: 스택킹 시각화 없음

**현재 동작:**
- 손패 카드가 매칭 카드와 "같은 위치"로 이동
- 두 카드가 완전히 겹쳐서 쌓인 것처럼 안 보임

**개선 필요:**
- 카드가 쌓일 때 약간의 offset을 주어 여러 장이 쌓인 것이 보여야 함
- 예: `Offset(3, -5)` 정도로 우상향 비켜서 쌓기

**관련 코드:** `lib/ui/game/game_screen_new.dart:791-802` - `_playCard()`

---

### 문제 4: 쪽(Kiss) 상황에서 덱 카드 목적지 불명확

**쪽 발생 조건:**
- 내가 낸 손패 카드가 바닥에 매칭 없음
- 덱에서 뒤집은 카드가 내가 낸 손패 카드와 같은 월

**현재 문제:**
- 덱 카드가 "방금 내가 낸 손패 카드 위치"로 날아가는 것이 명확하지 않음

**관련 코드:** `lib/ui/game/game_screen_new.dart:457-509` - `_processScenarioB()`

---

### 문제 5: 획득 전 스택 상태 표시 시간 부족

**현재 동작:**
- 덱 플립 완료 → 거의 즉시 획득 애니메이션 시작

**문제점:**
- 카드들이 바닥에 쌓인 상태를 볼 시간이 없음
- 특히 따닥(4장), 뻑(3장 스택) 상황에서 중요

**관련 코드:**
- `lib/ui/game/game_screen_new.dart:289-292` - 시나리오 B→C 사이에 딜레이 없음

---

## 개선 작업 항목

### 1. 덱 플립 후 공중 대기 시간 증가 (우선순위: 높음)

**파일:** `lib/ui/game/animations/card_animator.dart`

**변경 내용:**
```dart
// 기존
Duration pauseDuration = const Duration(milliseconds: 300),

// 변경
Duration pauseDuration = const Duration(milliseconds: 600),
```

---

### 2. 덱 카드 "던지기" 애니메이션 분리 (우선순위: 높음)

**파일:** `lib/ui/game/animations/card_animator.dart` - `playDeckFlipToFloor()`

**현재 흐름:**
```
Phase 1: 덱에서 올라오며 뒤집기 (400ms)
Phase 2: 바로 목적지로 이동 (350ms)
```

**개선 흐름:**
```
Phase 1: 덱에서 올라오며 뒤집기 (400ms)
Phase 2: 공중에서 대기 - 카드 확인 시간 (500ms)
Phase 3: 목적지로 "던지기" 애니메이션 (400ms) - 포물선 궤적
```

---

### 3. 쪽(Kiss) 상황 덱 카드 목적지 정확히 설정 (우선순위: 높음)

**파일:** `lib/ui/game/game_screen_new.dart` - `_processScenarioB()`

**변경 로직:**
```dart
// 쪽 감지: 이전 턴에 내가 낸 카드와 덱 카드가 같은 월인지 확인
// 이전 손패에서 사라진 카드 ID 찾기
// 해당 카드가 현재 바닥에 있고 + 덱 카드와 같은 월이면 → 쪽
// 덱 카드 목적지 = 내가 낸 손패 카드 위치
```

---

### 4. 카드 스택킹 offset 시각화 (우선순위: 중간)

**파일:** `lib/ui/game/game_screen_new.dart` - `_playCard()`

**변경 내용:**
```dart
// 매칭 카드 위치에 스택 offset 추가
final stackOffset = Offset(4, -6); // 우상향으로 살짝 비켜서 쌓임
final targetPosition = matchingCardPosition + stackOffset;
```

---

### 5. 시나리오 B→C 사이 딜레이 추가 (우선순위: 중간)

**파일:** `lib/ui/game/game_screen_new.dart` - `_processStateChangeAnimations()`

**변경 내용:**
```dart
// 시나리오 B 완료 후
await _processScenarioB(previousState, currentState, cachedFloorPositions);

// 스택 상태 표시를 위한 딜레이 추가
await Future.delayed(const Duration(milliseconds: 400));

// 시나리오 C 실행
await _processScenarioC(previousState, currentState, myUid, cachedFloorPositions);
```

---

## 특수 상황별 개선된 애니메이션 시퀀스

### 일반 2장 매칭
```
1. 손패 → 매칭 바닥카드 위 (스택 offset 적용)
2. 덱 플립 → 공중 대기 (500ms)
3. 덱 카드 → 빈 공간으로 던짐
4. 400ms 대기
5. 손패+매칭카드 2장 → 획득 영역으로
```

### 쪽 (Kiss)
```
1. 손패 → 빈 공간으로 던짐 (매칭 없음)
2. 덱 플립 → 공중 대기 (500ms)
3. 덱 카드 → 손패카드 위치로 던짐 (스택 offset)
4. 500ms 대기 (쪽 인지 시간)
5. 2장 → 획득 영역으로
```

### 따닥 (Ttadak)
```
1. 손패 → 매칭 바닥카드 위 (스택 offset)
2. 덱 플립 → 공중 대기 (500ms)
3. 덱 카드 → 다른 매칭 바닥카드 위로 던짐
4. 500ms 대기 (따닥 인지 시간)
5. 4장 모두 모아서 → 획득 영역으로
```

### 뻑 (Puk)
```
1. 손패 → 매칭 바닥카드 위 (2장 스택)
2. 덱 플립 → 공중 대기 (500ms)
3. 덱 카드 → 스택 위로 던짐 (3장 스택)
4. "뻑" 오버레이 표시
5. 획득 애니메이션 없음 - 3장이 바닥에 유지됨
```

---

## 관련 파일 목록

| 파일 | 역할 |
|------|------|
| `lib/ui/game/animations/card_animator.dart` | 실제 애니메이션 실행 (위치, 회전, 스케일 계산) |
| `lib/ui/game/animations/card_animation_controller.dart` | 고수준 애니메이션 API |
| `lib/ui/game/animations/card_journey.dart` | 물리 기반 커브, 위치 계산 유틸리티 |
| `lib/ui/game/animations/animated_card_overlay.dart` | 애니메이션 카드 렌더링 오버레이 |
| `lib/ui/game/game_screen_new.dart` | 게임 화면 - 애니메이션 트리거 및 시나리오 처리 |

---

## 테스트 시나리오

작업 완료 후 다음 상황에서 애니메이션 확인:

1. [ ] 일반 2장 매칭 - 손패+바닥 카드 획득
2. [ ] 쪽 - 손패와 덱 카드가 같은 월
3. [ ] 따닥 - 4장 동시 획득
4. [ ] 뻑 - 3장 스택 후 획득 없음
5. [ ] 자뻑 - 내가 쌓은 뻑을 내가 먹음
6. [ ] 싹쓸이 - 바닥 비우기
7. [ ] 매칭 없음 - 손패, 덱 모두 빈 공간으로
